<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        .link line {
            stroke: #696969;
        }

        .link line.separator {
            stroke: #fff;
            stroke-width: 2px;
        }

        .node circle {
            stroke: #000;
            stroke-width: 1.5px;
        }

        .node text {
            font: 10px sans-serif;
            pointer-events: none;
        }

        canvas {
            margin: 0 auto;
            background: #444;
        }
    </style>
    <script src="http://d3js.org/d3.v2.js?2.9.6"></script>
</head>
<body>
<script>
    var width = window.innerWidth - 20,
            height = window.innerHeight - 20;

    var color = d3.scale.category20();

    var zoomValue = -.5;
    var zoom = d3.behavior.zoom();
    var lastZoom = 1;


    var canvas = d3.select("body").append("canvas")
            .attr("width", width)
            .attr("height", height)
            .call(zoom);

    var context = canvas.node().getContext("2d");
    context.fillStyle = "steelblue";
    context.strokeStyle = "#666";
    context.strokeWidth = 1.5;

    var radius = d3.scale.sqrt()
            .range([0, 4]);

    var sw = d3.scale.sqrt()
            .range([0.01, 0.2]);

    var force = d3.layout.force()
            .size([width, height])
            //.charge(-150)
            .linkDistance(function (d) {
                return radius(d.source.size) + radius(d.target.size) + 20;
            });

    d3.json("graph.json", function (graph) {

        graph.nodes.forEach(function (d) {
            color(d.type);
            radius(d.size);
            sw(d.size);
        });

        force
            .nodes(graph.nodes)
            .links(graph.edges)
            .on("tick", tick)
            .start();

        zoom.on("zoom", function () {
            if (lastZoom < d3.event.scale)
                zoomValue++;
            else if (lastZoom > d3.event.scale)
                zoomValue--;
            lastZoom = d3.event.scale;
            tick();
        });

        function tick() {
            var scale = Math.pow(Math.sqrt(2), zoomValue),
                sizeFactor = scale * Math.pow(scale, -.15),
                edgeSizeFactor = sizeFactor,
                nodeSizeFactor = sizeFactor,
                centerX = (window.innerWidth - 20) / 2,
                centerY = (window.innerHeight - 20) / 2,
                delx = centerX - (centerX * scale),
                dely = centerY - (centerY * scale);

            context.clearRect(0, 0, width, height);

            force.links().forEach(function (e) {
                context.beginPath();

                context.strokeStyle = d3.rgb(color(e.target.type)).toString();
                context.lineWidth = sw(e.target.size) * edgeSizeFactor;

                var xs = scale * e.source.x + delx,
                    ys = scale * e.source.y + dely,
                    xt = scale * e.target.x + delx,
                    yt = scale * e.target.y + dely;

                e.source.visibile = xs > 0 && xs < width && ys > 0 && ys < height;
                e.target.visibile = xt > 0 && xt < width && yt > 0 && yt < height;

                if (e.source.visibile || e.target.visibile) {
                    context.moveTo(xs, ys);
                    var x3 = .3 * yt - .3 * ys + .8 * xs + .2 * xt;
                    var y3 = .8 * ys + .2 * yt - .3 * xt + .3 * xs;
                    var x4 = .3 * yt - .3 * ys + .2 * xs + .8 * xt;
                    var y4 = .2 * ys + .8 * yt - .3 * xt + .3 * xs;
                    context.bezierCurveTo(x3, y3, x4, y4, xt, yt);
                    context.stroke();
                }
            });

            force.nodes().forEach(function (d) {
                var dx = scale * d.x + delx,
                        dy = scale * d.y + dely;
                if (d.visibile) {
                    context.beginPath();
                    context.fillStyle = d3.rgb(color(d.type)).toString();
                    context.strokeStyle = d3.rgb(color(d.type)).darker().toString();
                    context.lineWidth = sw(d.size) * edgeSizeFactor;
                    context.arc(dx, dy, radius(d.size) * nodeSizeFactor, 0, Math.PI * 2, true);
                    context.fill();
                    context.stroke();
                }
            });
        }
    });
</script>
</body>
</html>